# Payments Advanced Data Quality Rules
dataset: silver.payments
product: Payments
domain: Trading
owner: payments_dp@company.com

# Advanced validation rules
rules:
  - id: payments.fk.account_exists.v01
    dq_category: integrity
    dq_check_type: fk_exists
    engine: sql
    sql: |
      SELECT COUNT(*) AS violations
      FROM silver.payments p
      LEFT JOIN silver.accounts a ON p.account_id = a.account_id
      WHERE a.account_id IS NULL AND p.event_date = '${PARTITION_VALUE}'
    threshold: { operator: "=", operand: 0 }
    severity: medium
    sla:
      target_pass_rate: 100.0
      window_days: 7

  - id: payments.freshness.hourly.v01
    dq_category: freshness
    dq_check_type: freshness_lag
    engine: soda
    params: { timestamp_column: ingestion_ts, max_lag_minutes: 75 }
    sla:
      target_pass_rate: 99.0
      window_days: 1

  - id: payments.amount.reasonable_range.v01
    dq_category: validity
    dq_check_type: value_range
    engine: sql
    sql: |
      SELECT COUNT(*) AS violations
      FROM silver.payments
      WHERE amount > 1000000 OR amount < -1000000
        AND event_date = '${PARTITION_VALUE}'
    threshold: { operator: "=", operand: 0 }
    severity: high
    sla:
      target_pass_rate: 99.9
      window_days: 7
